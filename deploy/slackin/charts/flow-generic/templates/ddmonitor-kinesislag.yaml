{{- $fullName := include "deploy.fullname" . -}}
{{- $ddmonitors := .Values.datadogMonitors -}}

{{- $warningnotiftarget := printf "@slack-team-%s-notifications" $.Values.team -}}
{{- $alertnotiftarget := printf "@pagerduty-%s" $.Values.team  -}}

{{- range $monitortype := $ddmonitors }}
{{- if eq $monitortype.type  "flow.lib_event.kinesis.consumer.lagMillis-avg" }}

apiVersion: datadoghq.com/v1alpha1
kind: DatadogMonitor
metadata:
  {{- if $monitortype.name }}
  name: {{ $fullName }}-kinesislag-{{ $monitortype.name }}
  {{- else }}
  name: {{ $fullName }}-kinesislag
  {{- end }}
  namespace: datadog
spec:
  options:
    notifyAudit: true
    renotifyInterval: 1440
    thresholds:
      {{- if $monitortype.warning }}
      warning: "{{ default "7200000" $monitortype.warning.threshold }}"
      {{- else }}
      warning: "7200000"
      {{- end }}
      {{- if $monitortype.alert }}
      critical: "{{ default "14400000" $monitortype.alert.threshold }}"
      {{- else }}
      critical: "14400000"
      {{- end }}
    newGroupDelay: {{ default 600 $monitortype.newGroupDelay }}
  query: >
    {{ default "avg" $monitortype.monitorMainOperator }}(
      {{ default "last_5m" $monitortype.interval }}
    ):avg:flow.lib_event.kinesis.consumer.lagMillis{
      env:live AND
      service:{{ $fullName }}
      {{- if $monitortype.filters }}
        AND ({{ $monitortype.filters }})
      {{- end }}
    } by {
      stream_name,
      service
    } >
    {{- if $monitortype.alert }}
      {{ default "14400000" $monitortype.alert.threshold }}
    {{- else }}
      14400000
    {{- end }}
  type: "query alert"
  name: '[generated] Service {{ $fullName }} {{ default "" $monitortype.name }} kinesis consumer {{ "{{" }}stream_name.name{{ "}}" }} lagging behind on env:live'
  message: |
    {{ $fullName }} {{ default "" $monitortype.name }} kinesis consumer for stream {{ "{{" }}stream_name.name{{ "}}" }} is lagging behind.

    Comment: {{ default "\n" $monitortype.comment }}

    {{- if $monitortype.warning }}
    {{ default $warningnotiftarget $monitortype.warning.notificationTarget }}
    {{- else }}
    {{ $warningnotiftarget }}
    {{- end }}

    {{ "{{" }}#is_alert{{ "}}" }}
      {{- if $monitortype.alert }}
      {{ default $alertnotiftarget $monitortype.alert.notificationTarget }}
      {{- else }}
      {{ $alertnotiftarget }}
      {{- end }}
    {{ "{{" }}/is_alert{{ "}}" }}
          
    {{ "{{" }}#is_alert_recovery{{ "}}" }}
      {{- if $monitortype.alert }}
      {{ default $alertnotiftarget $monitortype.alert.notificationTarget }}
      {{- else }}
      {{ $alertnotiftarget }}
      {{- end }}
    {{ "{{" }}/is_alert_recovery{{ "}}" }}

  tags:
    - "service:{{ $fullName }}"
    - "env:live"
    - "team:{{ $.Values.team }}"

---

{{- end }}
{{- end }}
